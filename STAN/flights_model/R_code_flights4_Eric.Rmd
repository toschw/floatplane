---
title: "StanAnalysis"
author: "Tobias Schwoerer"
date: "May 19 2020"
output: html_document
editor_options: 
  chunk_output_type: console
---
#Hierarchical model using Stan for estimating the probability of introducing aquatic invasive species to lake j  
## Code by Tobias Schwoerer, 05/27/20
## Useful references: Gelman et al. 2013. Bayesian Data Analysis 3rd ed. , Carpenter et al. 2016. Stan: A probabilistic programming language. Journal of Statistical Software

#1 Set up
load packages, read in and prepare data for analysis 
```{r}
library(shinystan)
library(bayesplot)
library(ggplot2)
library(cowplot)
library(rstan)
library(dplyr)
library(tidyr)
library(foreign)
library(data.table)
library(tidyverse)

#importing data archived at https://doi.org/10.18739/A25H7BV1C 
data <- read.csv(url("https://arcticdata.io/metacat/d1/mn/v2/object/urn%3Auuid%3Aaac2cc93-04f3-4e5c-b36b-01120993f1d8",      method="libcurl"))
ref  <-  read.csv(url("https://arcticdata.io/metacat/d1/mn/v2/object/urn%3Auuid%3A8ed27563-55f2-4273-a272-09406d85419b",method="libcurl")) #contains destination-specific geographic information included in STANresults.csv

J <- nrow(data)
n <- data$flights
y <- data$eflights

```

#2 run model
```{r}
library(rstan)
rstan_options(auto_write = TRUE)
Sys.setenv(LOCAL_CPPFLAGS = '-march=native')
options(mc.cores = parallel::detectCores())

#datafit <- stan(file="D:/ANALYSIS_R/floatplane/STAN/flights_model/flights_model3.stan",data=c("J","y","n"), iter = 4000, chains = 4,control=list(adapt_delta=0.8, max_treedepth =15),verbose = TRUE)

# J = 300
# n = rpois(J, 20)
# y = rbinom(J, size =n, prob = rbeta(J, 1, 3))
data_list = list("J" = J, "y" = y, "n" = n)
pars = c("logit_lambda","lambda_sd", "lambda","theta")

# EW changed adapt_delta to 0.99, and max_treedepth = 20
datafit <- stan(file="flights_model4.stan",data=data_list, pars = pars, iter = 3000, chains = 4,
  control=list(adapt_delta=0.99, max_treedepth =20),verbose = TRUE)

which(summary(datafit)$summary[,"Rhat"] > 1.05)
pars=rstan::extract(datafit)
```


#3 pairs plot to check sampling efficiency
```{r}
  mcmc_pairs(
    posterior_cp,
    np = np_cp,
    pars = c("alpha", "beta", "lambda", "kappa", "theta[1]"),
    transformations = list(
      "lambda" = "qlogis",  # or define a function called logit
      "kappa" = function(x) log(x - 0.1),
      "theta[1]" = "qlogis"
    ),
    off_diag_args = list(size = 0.75)
  )

plots2 <- pairs_plot2$bayesplots # list of 25 ggplot objects (diagonal plots are in slots 1,7,13,19,25)
plots2
```




#3 Model output
```{r}  
#Save posterior summary statistics (contains sampling diagnostics)
fit_summary <- summary(datafit)
fit_summary.df <- as.data.frame(fit_summary$summary)
fitS <- setDT(fit_summary.df, keep.rownames = "X")
fitS <- fitS[1:727,]
results <- fitS%>%
  left_join(ref, by=c("X"="Ã¯..modelID"))

#Sort by median predicted introduction rate and inverse variance
results <- results[order(-results$X50.,results$sd),]
results <- results%>% 
  mutate(rank = row_number())

#Move columns for easier reading starting with Rank, UniqueID, 
results <-results[c("rank","UniqueID","DestName","Name","RegionName","DestType","Lat", "Long","HUC8","GMU","mean","se_mean","sd","X2.5.","X25.","X50.","X75.","X97.5.","n_eff","Rhat","WithinNPS","WithinRefu","Suitab","Fetch_m","ElevMEAN","flights","eflights","X")]
write.csv(results, file="/STANresults.csv",row.names = FALSE)
```


#4 Model diagnostic and validation
##4.1 Posterior predictive check
plotting observed introduction rates versus posterior medians with 95% posterior intervals
```{r}
library(plyr)
library(dplyr)
library(ggplot2)
sdata <- read.csv("STAN/flights_model/fit_summary3.csv")
data <-  read.csv("STAN/floatplanedata4.csv")
data$rate <- data$eflights/data$flights

theme_set(theme_classic(base_size = 7))

##renaming columns of above data frame
names(sdata)[5:9] <- c("perc3","perc25","perc50","perc75","perc97")
#selecting first 729 rows for the draws
sdata2 <- sdata[1:727,]
sdata2 <- cbind(sdata2,data)

ScatterFig <-  ggplot(sdata2, aes(x=sdata2$rate,y=sdata2$perc50)) +
  geom_pointrange(aes(ymin=sdata2$perc3, ymax=sdata2$perc97)) + 
  xlab("observed introduction rate")+ ylab("95% posterior interval for theta(j)") +
  ylim(0,1)+ xlim(0,1) + geom_jitter(height=0,width=0.1)+ geom_abline(intercept = 0, slope = 1,colour='red')+
  theme(axis.title.x = element_text(face="bold", colour="#000000", size=7),
        axis.text.x  = element_text(face="bold", angle=0, vjust=0.5, size=7)) +
  theme(axis.title.y = element_text(face="bold", colour="#000000", size=7),
        axis.text.y  = element_text(face="bold", angle=360, vjust=0.5, size=7))+
  theme(panel.background = element_rect(fill = 'white', colour="black"))
ScatterFig
ggsave("STAN/flights_model/figures/datafit3Figures/ScatterFig.bmp", plot = last_plot(), device = "bmp", path = NULL,
  scale = 1, width = 90, height = 140, units = "mm",
  dpi = 300, limitsize = TRUE)
```

##4.2 Model checking
external validation
```{r}
data_sims <- extract(datafit3, permuted=TRUE)
theta_rep <- array(NA,c(n_sims,J))
y_rep <- array(NA,c(n_sims,J))
for (s in 1:n_sims){
  theta_rep[s,] <- rbeta(J,data_sims$alpha[s],data_sims$beta[s])
  y_rep[s,] <- rbinom(J,n_sims,theta_rep[s,])
}

 #displaying replicated data
par(mfrow=c(5,4),mar=c(4,4,2,2))
hist(y/n,xlab="",main="observed")
for (s in 1:19)
  hist(theta_rep[s,], xlab="",main=paste("theta_rep",s))
 #Saved figure manually for Supplementary File

 #calculating mean and SD for replicated new data
theta_rep_mean <- mean(theta_rep)
theta_rep_mean
theta_rep_sd <- sd(theta_rep)
theta_rep_sd

ratios_cp <- neff_ratio(datafit3)
mcmc_neff(ratios_cp, size = 2)
```
Results:
theta_rep_mean = 0.236
theta_rep_sd = 0.361

Also, the ratios are very low, below 0.1 which may hint torwards the need to reparameterize. See: https://cran.r-project.org/web/packages/bayesplot/vignettes/visual-mcmc-diagnostics.html#rhat-potential-scale-reduction-statistic

##4.3 Convergence check
Rhat, traceplot, energy plot, pairs plot 
```{r}
#number of lakes with Rhat<=1.05 Rhat<=1.1 and Rhat>1.1
df <- fit_summary.df[1:727,]#subsetting to just include the thetas for 727 lakes
df <- cbind(df,ref)
nrow(subset(df,Rhat<=1.05))
nrow(subset(df,Rhat<=1.1))
nrow(subset(df,Rhat>1.1))


#traceplots
traceplot <- stan_trace(datafit3, pars = c("theta[322]","theta[324]","theta[518]","avg"), inc_warmup = TRUE, nrow = 9)
levels(traceplot$data$parameter)[1] <- "Martin Lake"
levels(traceplot$data$parameter)[2] <- "McKinley Lake"
levels(traceplot$data$parameter)[3] <- "Alexander Lake"
levels(traceplot$data$parameter)[4] <- "Average"
traceplot <- traceplot + xlab("iteration") + ylab("posterior for theta(j)")
traceplot

ggsave("STAN/flights_model/figures/datafit3Figures/traceplot.bmp", plot = last_plot(), device = "bmp", path = NULL,
  scale = 1, width = 140, height = 140, units = "mm",
  dpi = 300, limitsize = TRUE)

#energy plot
posterior_cp <- as.array(datafit3)
np_cp <- nuts_params(datafit3)
color_scheme_set("blue")
mcmc_nuts_energy(np_cp)
ggsave("STAN/flights_model/figures/datafit3Figures/energyplot.bmp", plot = last_plot(), device = "bmp", path = NULL,
  scale = 1, width = 140, height = 140, units = "mm",
  dpi = 300, limitsize = TRUE)

#pairsplot (note, using just one theta to keep the plot readable)
theme_set(theme_classic(base_size = 7))
color_scheme_set("darkgray")

#mcmc_parcoord(posterior_cp, np = np_cp) #generates error: cannot allocate vector of size 889.3 Mb 
pairs_plot <- mcmc_pairs(posterior_cp, np = np_cp, pars = c("alpha","beta","lambda","kappa","theta[1]"), 
           off_diag_args = list(size = 0.75))

plots <- pairs_plot$bayesplots # list of 25 ggplot objects (diagonal plots are in slots 1,7,13,19,25)

#Note, to save the grid of the plots, set plots=bayesplot_grid(plots = plots)
ggsave("STAN/flights_model/figures/datafit3Figures/pairs_plot.jpeg", plot = bayesplot_grid(plots = plots), device = "jpeg", path = NULL,
  scale = 1, width = 140, height = 140, units = "mm",
  dpi = 300, limitsize = TRUE)

#pairsplot for Aki Vehtari with help from Jonah Gabry
pairs_plot2 <-
  mcmc_pairs(
    posterior_cp,
    np = np_cp,
    pars = c("alpha", "beta", "lambda", "kappa", "theta[1]"),
    transformations = list(
      "lambda" = "qlogis",  # or define a function called logit
      "kappa" = function(x) log(x - 0.1),
      "theta[1]" = "qlogis"
    ),
    off_diag_args = list(size = 0.75)
  )

plots2 <- pairs_plot2$bayesplots # list of 25 ggplot objects (diagonal plots are in slots 1,7,13,19,25)
plots2
#Note, to save the grid of the plots, set plots=bayesplot_grid(plots = plots)
ggsave("STAN/flights_model/figures/datafit3Figures/pairs_plot3.jpeg", plot = bayesplot_grid(plots = plots2), device = "jpeg", path = NULL,
  scale = 1, width = 140, height = 140, units = "mm",
  dpi = 300, limitsize = TRUE)

```
Result: consistent with model output, no divergences found. 

#5 Visualizing results
posteriors for known elodea-invaded lakes
```{r}
theme_set(theme_classic(base_size = 7))  #NOT WORKING HERE --> FIX!
library(ggplot2)
library(rstan)
FigPosteriors <- plot(datafit3, show_density = TRUE, pars=c("theta[321]","theta[322]","theta[324]","theta[376]","theta[518]","theta[300]","theta[309]","theta[376]","theta[347]","avg"), ci_level = 0.5, fill_color = "#99d8c9")
chvector <- character(length=9)
chvector <- c("Average", "Lake Hood","Daniels Lake","Stormy Lake","Alexander Lake","Sucker Lake","McKinley Lake","Martin Lake","Bering Lake")
FigPosteriors <- FigPosteriors + scale_y_continuous(labels=chvector[1:9],breaks=1:9) + labs(x="95% posterior for theta(j)")
FigPosteriors

ggsave("STAN/flights_model/figures/datafit3Figures/FigPosteriors.bmp", plot = last_plot(), device = "bmp", path = NULL,
  scale = 1, width = 140, height = 140, units = "mm",
  dpi = 300, limitsize = TRUE)

#Better publication version of the above, code not working correctly yet
posterior <- as.array(datafit3)
fig <- mcmc_areas(
  posterior, 
  pars = c("theta[321]","theta[322]","theta[324]","theta[376]","theta[518]","theta[300]","theta[309]","theta[376]","avg"),
  prob = 0.5, # 50% intervals
  prob_outer = 0.95, # 95%
  point_est = "median"
)

fig <- fig + scale_y_discrete(labels=chvector[1:9],breaks=1:9) + labs(x="95% posterior for theta(j)")
fig
```


Creating results table for seaplane bases
```{r}
FAAbases <- read.csv("Data/FAAbases.csv", stringsAsFactors = FALSE)
bases <- FAAbases[,2]
basesResults <- subset(results, UniqueID %in% bases)
```


Looking for divergences
```{r}
partition <- util$partition_div(datafit3)
div_samples <- partition[[1]]
nondiv_samples <- partition[[2]]

par(mfrow=c(1, 3))

plot(nondiv_samples$a, nondiv_samples$b,
     col=c_dark_trans, pch=16, cex=0.8,
     xlab="a", ylab="b")
points(div_samples$a, div_samples$b,
       col="green", pch=16, cex=0.8)

plot(nondiv_samples$a, log(nondiv_samples$sigma),
     col=c_dark_trans, pch=16, cex=0.8,
     xlab="a", ylab="log(sigma)")
points(div_samples$a, log(div_samples$sigma),
       col="green", pch=16, cex=0.8)

plot(nondiv_samples$b, log(nondiv_samples$sigma),
     col=c_dark_trans, pch=16, cex=0.8,
     xlab="b", ylab="log(sigma)")
points(div_samples$b, log(div_samples$sigma),
       col="green", pch=16, cex=0.8)
```
